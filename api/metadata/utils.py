import json
import os
import requests

from urlobject import URLObject

from django.conf import settings
from django.core.cache import cache

from mohawk import Sender

from api.wto.models import WTOCommitteeGroup

from .constants import BARRIER_TYPE_CATEGORIES, TRADING_BLOCS
from .models import Category, BarrierPriority, BarrierTag


def import_api_results(endpoint):
    # Avoid calling DH
    fake_it = settings.FAKE_METADATA
    if fake_it:
        # TODO: fake all metadata, not just a part of it
        #       currently only a few countries are made available
        file_path = os.path.join(settings.BASE_DIR, f"static/{endpoint}.json")
        return json.loads(open(file_path).read())

    base_url = URLObject(settings.DH_METADATA_URL)

    # v4 endpoints do not have trailing forward slash
    meta_url = base_url.relative(f"./{endpoint}")

    credentials = settings.HAWK_CREDENTIALS[settings.DATAHUB_HAWK_ID]

    sender = Sender(credentials,
                    meta_url,
                    'GET',
                    content=None,
                    content_type=None,
                    always_hash_content=False,
                    )

    response = requests.get(meta_url, verify=not settings.DEBUG,
                            headers={
                                'Authorization': sender.request_header
                            })

    if response.ok:
        return response.json()

    return None


def get_os_regions_and_countries():
    dh_countries = import_api_results("country")
    dh_os_regions = []
    for item in dh_countries:
        if item["overseas_region"] not in dh_os_regions:
            # there are few countries with no overseas region
            if item["overseas_region"] is not None:
                dh_os_regions.append(item["overseas_region"])
    return dh_os_regions, dh_countries


def get_country(country_id):
    country_lookup = cache.get("dh_country_lookup")
    if not country_lookup:
        country_lookup = {country["id"]: country for country in get_countries()}
        cache.set("dh_country_lookup", country_lookup, 7200)
    country = country_lookup.get(country_id)
    if country:
        country["trading_bloc"] = get_trading_bloc_by_country_id(country["id"])
    return country


def get_countries():
    dh_regions, dh_countries = get_os_regions_and_countries()
    return dh_countries


def get_country_ids_by_overseas_region(region_id):
    countries = get_countries()
    return [
        country["id"] for country in countries
        if country.get("overseas_region")
        and region_id == country.get("overseas_region").get("id")
    ]


def get_admin_area(admin_area_id):
    admin_area_lookup = cache.get("dh_admin_area_lookup")
    if not admin_area_lookup:
        admin_area_lookup = {
            admin_area["id"]: admin_area for admin_area in get_admin_areas()
        }
        cache.set("dh_admin_area_lookup", admin_area_lookup, 7200)
    return admin_area_lookup.get(str(admin_area_id))


def get_admin_areas():
    return import_api_results("administrative-area")


def get_overseas_region(overseas_region_id):
    overseas_region_lookup = cache.get("dh_overseas_region_lookup")
    if not overseas_region_lookup:
        dh_countries = import_api_results("country")
        overseas_region_lookup = {}
        for country in dh_countries:
            if country.get("overseas_region"):
                overseas_region = country["overseas_region"]
                overseas_region_lookup[overseas_region["id"]] = overseas_region

        cache.set("dh_overseas_region_lookup", overseas_region_lookup, 7200)
    return overseas_region_lookup.get(str(overseas_region_id))


def get_sector(sector_id):
    sector_lookup = cache.get("dh_sector_lookup")
    if not sector_lookup:
        sector_lookup = {sector["id"]: sector for sector in get_sectors()}
        cache.set("dh_sector_lookup", sector_lookup, 7200)
    return sector_lookup.get(str(sector_id))


def get_sectors():
    return import_api_results("sector")


def get_categories():
    barrier_goods = [
        {
            "id": category.id,
            "title": category.title,
            "description": category.description,
            "category": "GOODS",
        }
        for category in Category.goods.all()
    ]
    barrier_services = [
        {
            "id": category.id,
            "title": category.title,
            "description": category.description,
            "category": "SERVICES",
        }
        for category in Category.services.all()
    ]
    return barrier_goods + barrier_services


def get_barrier_tags():
    return list(BarrierTag.objects.values(
        "id", "title", "description", "show_at_reporting", "order"
    ))


def get_barrier_priorities():
    return [
        {"code": priority.code, "name": priority.name, "order": priority.order}
        for priority in BarrierPriority.objects.all()
    ]


def get_barrier_type_categories():
    return dict(
        (x, y) for x, y in BARRIER_TYPE_CATEGORIES if x != "GOODSANDSERVICES"
    )


def get_reporting_stages():
    from api.barriers.models import Stage
    return dict((stage.code, stage.description) for stage in Stage.objects.order_by('id'))


def get_trading_bloc(code):
    trading_bloc = TRADING_BLOCS.get(code)
    if trading_bloc:
        return {
            "code": trading_bloc["code"],
            "name": trading_bloc["name"],
            "short_name": trading_bloc["short_name"],
            "overseas_regions": get_trading_bloc_overseas_regions(trading_bloc["code"]),
        }


def get_trading_bloc_by_country_id(country_id):
    for trading_bloc in TRADING_BLOCS.values():
        if country_id in trading_bloc["country_ids"]:
            return {
                "code": trading_bloc["code"],
                "name": trading_bloc["name"],
                "short_name": trading_bloc["short_name"],
                "overseas_regions": get_trading_bloc_overseas_regions(trading_bloc["code"]),
            }


def get_trading_bloc_country_ids(trading_bloc_code):
    return TRADING_BLOCS.get(trading_bloc_code, {}).get("country_ids", [])


def get_trading_bloc_overseas_region_ids(trading_bloc_code):
    return TRADING_BLOCS.get(trading_bloc_code, {}).get("overseas_regions", [])


def get_trading_bloc_overseas_regions(trading_bloc_code):
    overseas_region_ids = get_trading_bloc_overseas_region_ids(trading_bloc_code)
    return [get_overseas_region(region_id) for region_id in overseas_region_ids]


def get_wto_committee_groups():
    committee_groups = []
    for group in WTOCommitteeGroup.objects.all():
        committee_groups.append({
            "id": str(group.id),
            "name": group.name,
            "wto_committees": [
                {
                    "id": str(committee.id),
                    "name": committee.name,
                } for committee in group.committees.all()
            ],
        })
    return committee_groups


def get_location_text(country_id, trading_bloc=None, caused_by_trading_bloc=None, admin_area_ids=()):
    if not country_id:
        if trading_bloc:
            return TRADING_BLOCS.get(trading_bloc, {}).get("name")
        return None

    country = get_country(str(country_id))
    if not country:
        return None
    country_name = country["name"]

    if caused_by_trading_bloc and country.get("trading_bloc"):
        trading_bloc = country.get("trading_bloc", {}).get("name", "")
        return f"{country_name} ({trading_bloc})"

    if admin_area_ids:
        def admin_area_name(admin_area_id):
            admin_area = get_admin_area(admin_area_id) or {}
            return admin_area.get("name", "")

        admin_areas_string = ", ".join(admin_area_name(_id) for _id in admin_area_ids)
        return f"{admin_areas_string} ({country_name})"

    return country_name
